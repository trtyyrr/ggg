<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Valae Magisk Factory v2.0</title>
    <style>
        :root { --neon: #ff003c; --bg: #0d0d0d; }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; }
        .card { width: 100%; max-width: 800px; border: 2px solid var(--neon); padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(255,0,60,0.2); }
        h1 { text-align: center; letter-spacing: 3px; border-bottom: 1px solid var(--neon); padding-bottom: 10px; }
        textarea { width: 100%; height: 150px; background: #000; color: #fff; border: 1px solid var(--neon); padding: 15px; font-size: 16px; margin: 20px 0; box-sizing: border-box; }
        button { background: var(--neon); color: #fff; border: none; width: 100%; padding: 20px; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        button:hover { background: #fff; color: var(--neon); box-shadow: 0 0 20px #fff; }
        #console { background: #000; border: 1px solid #333; height: 250px; overflow-y: auto; padding: 15px; font-size: 13px; margin-top: 20px; color: #888; border-radius: 5px; }
        .ok { color: #00ff41; }
        .err { color: #ff4444; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”¥ VALAE MAGISK FACTORY</h1>
    <p style="text-align: center; color: #666;">è‡ªåŠ¨ç”Ÿæˆ Magisk æ¨¡å—æºç å¹¶è§¦å‘ GitHub æ‰“åŒ…</p>
    
    <textarea id="prompt" placeholder="ä¾‹å¦‚ï¼šåšä¸€ä¸ªå°†ç³»ç»Ÿå­—ä½“æ”¹ä¸ºç˜¦é‡‘ä½“çš„æ¨¡å—ã€‚"></textarea>
    
    <button onclick="ignite()">ä¸€é”®ç”Ÿäº§æ¨¡å—</button>

    <div id="console">ç­‰å¾…æŒ‡ä»¤ä¸‹è¾¾...</div>
</div>

<script>
    /* --- è‡ªåŠ¨ä¿®å¤é…ç½®åŒº --- */
    // å¦‚æœè¿™é‡Œè¯¯è¾“å…¥äº†ç©ºæ ¼æˆ–ä¸­æ–‡ç¬¦å·ï¼Œä¸‹æ–¹çš„ä»£ç ä¼šè‡ªåŠ¨æ¸…ç†
    const RAW_DS_KEY = "ä½ çš„DEEPSEEKå¯†é’¥"; 
    const RAW_GH_TOKEN = "ä½ çš„GITHUBå¯†é’¥"; 
    const RAW_REPO = "ç”¨æˆ·å/ä»“åº“å"; 

    // ğŸ§  ä¸“å®¶è®­ç»ƒæŒ‡ä»¤
    const SYSTEM_RULES = `ä½ æ˜¯ä¸€ä¸ª Magisk æ¨¡å—ä¸“å®¶ã€‚æŒ‰è¦æ±‚è¾“å‡º JSONã€‚
    å¿…é¡»åŒ…å«ï¼š
    1. module.prop (id, name, version, author, description)
    2. service.sh (æ ¸å¿ƒé€»è¾‘)
    3. install.sh (å®‰è£…è„šæœ¬)
    4. system/fonts/ (å¦‚æœæ¶‰åŠå­—ä½“ä¿®æ”¹)
    è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š{"files": [{"path": "module.prop", "content": "..."}]}`;

    async function log(msg, type = '') {
        const c = document.getElementById('console');
        const div = document.createElement('div');
        div.className = type;
        div.innerHTML = `> ${msg}`;
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    async function ignite() {
        const prompt = document.getElementById('prompt').value;
        if(!prompt) return;

        // ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ¸…ç†æ‰€æœ‰é ISO-8859-1 å­—ç¬¦ï¼Œé˜²æ­¢ Fetch æŠ¥é”™
        const DS_KEY = RAW_DS_KEY.replace(/[^\x00-\x7F]/g, "").trim();
        const GH_TOKEN = RAW_GH_TOKEN.replace(/[^\x00-\x7F]/g, "").trim();
        const REPO = RAW_REPO.replace(/[^\x00-\x7F]/g, "").trim();

        document.getElementById('console').innerHTML = ""; 
        log("ğŸš€ å¼•æ“åˆå§‹åŒ–...", "ok");

        try {
            log("æ­£åœ¨è¯·æ±‚ DeepSeek AI æ„å»ºæ¶æ„...");
            const aiRes = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DS_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "system", content: SYSTEM_RULES}, {role: "user", content: prompt}],
                    response_format: { type: 'json_object' }
                })
            });

            if(!aiRes.ok) throw new Error("AI å¯†é’¥æ— æ•ˆæˆ–ä½™é¢ä¸è¶³");

            const data = await aiRes.json();
            const files = JSON.parse(data.choices[0].message.content).files;
            log(`æ¶æ„è®¾è®¡æˆåŠŸï¼Œå…± ${files.length} ä¸ªæ–‡ä»¶`, "ok");

            for (const file of files) {
                log(`æ­£åœ¨æ¨é€: ${file.path}`);
                const url = `https://api.github.com/repos/${REPO}/contents/${file.path}`;
                
                let sha = "";
                const check = await fetch(url, { headers: {'Authorization': `token ${GH_TOKEN}`} });
                if(check.ok) { const meta = await check.json(); sha = meta.sha; }

                const push = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `V-Magisk Build: ${file.path}`,
                        content: btoa(unescape(encodeURIComponent(file.content))),
                        sha: sha || undefined
                    })
                });
                if(push.ok) log(`âœ… ${file.path} å·²å…¥åº“`, "ok");
            }

            log("---------------------------------------");
            log("âœ¨ æºç åŒæ­¥å®Œæˆï¼è¯·å‰å¾€ GitHub Actions ä¸‹è½½ ZIP åŒ…ã€‚", "ok");

        } catch (e) {
            log("ğŸ’¥ è‡´å‘½é”™è¯¯: " + e.message, "err");
        }
    }
</script>
</body>
</html>